# Galaxy Number Counts in a Single CCD Field

This repository contains the code for my Year 3 Astrophysics lab project on
**galaxy number counts** and the **log N–m relation** from a single CCD
mosaic image. The field is strongly affected by a bright saturated star and
its halo, so a major part of the work is cleaning artefacts and understanding
how they affect the counts. The figures and numerical results produced by this
code are used in the written lab report.

1. **Data**

   The analysis uses the following FITS images, provided as part of the lab:

   - `mosaic.fits`  
     Raw (or pipeline–reduced) CCD mosaic.

   - `mosaic_cleaned_enhanced.fits`  
     Mosaic after saturated–star / halo cleaning.  
     This is generated by the halo–removal notebook in this repository.

   > **Note:** The FITS files themselves are not stored in this public
   > repository. To run the notebooks, copy `mosaic.fits` (and, if needed,
   > `mosaic_cleaned_enhanced.fits`) into the repository root from the lab
   > data distribution.

2. **Environment and dependencies**

   The analysis is done in Python using Jupyter notebooks.

   Tested with:

   - Python 3.x (Anaconda recommended)  
   - `numpy`  
   - `scipy`  
   - `astropy`  
   - `matplotlib`  
   - `photutils` (optional; used only in some experiments)



3. **Repository contents**

   Main notebooks:

   - `read_mosaic.ipynb`  
     Load `mosaic.fits`, display the image, compute robust background statistics  
     (median, MAD-based sigma), and inspect the raw field.

   - `histogram_mosaic.ipynb`  
     Make histograms of pixel values, fit a Gaussian to the sky distribution, and  
     verify the global background and sigma used for detection thresholds.

   - `background_saturation_remove.ipynb`  
     Explore methods to identify and remove saturated regions and the bright-star  
     halo. Implements:  
     - robust background and sigma estimates  
     - saturation thresholds  
     - connected–component labelling  
     - k–nearest–neighbour (kNN) density–based halo removal  
     - creation of `mosaic_cleaned_enhanced.fits`  
     - diagnostic plots (before/after cleaning overlays)

   - `aperture photometry.ipynb`  
     Implements circular aperture photometry with a 3 arcsec diameter:  
     - converts the 3″ diameter to a pixel radius using the 0.258″/pix scale  
     - estimates local sky using an annulus (inner and outer radii in pixels)  
     - computes net flux and basic flux uncertainty  
     - tests the photometry on bright isolated sources

   - `analysis.ipynb`  
     Main analysis pipeline:  
     - source detection using a threshold of `bg + 5σ`  
     - minimum area and edge cuts on detections  
     - optional application of the kNN-based halo mask  
     - star/galaxy separation using a concentration index and equal-area radius  
     - conversion of net flux to calibrated magnitudes using the photometric  
       zero point (e.g. `ZP = 25.3` mag)

   - `results.ipynb`  
     Final science products:  
     - cumulative `log₁₀ N(<m)` vs calibrated magnitude  
     - separate curves for all sources, stars, and galaxies  
     - Poisson error bars for each bin  
     - weighted linear fits to the galaxy `log N – m` relation over a chosen  
       magnitude range  
     - exploration of how tuning (fit range, kNN parameters) affects the slope  
       and its uncertainty  
     - export of the final plots as PNG/JPG for use in the report  

   There may also be small helper `.py` files with shared functions  
   (background estimation, detection, photometry). These are imported by more  
   than one notebook to avoid code duplication.

4. **How to run the analysis**

   A typical workflow to reproduce the figures and numbers in the report is:

   1. **Inspect the raw mosaic**  
      - Open `read_mosaic.ipynb`.  
      - Copy `mosaic.fits` into the repository root (if it is not already there).  
      - Run the notebook to display the field and compute the global background  
        and sigma.

   2. **Check the histogram and sky fit**  
      - Open `histogram_mosaic.ipynb`.  
      - Run to generate pixel-value histograms and fit a Gaussian to the sky.  
      - Confirm that the background level and sigma used for detection are  
        reasonable.

   3. **Clean the saturated star and halo**  
      - Open `background_saturation_remove.ipynb`.  
      - Run to:  
        - identify saturated cores and bleed trails,  
        - apply the kNN-based density filter to remove the bright halo ring,  
        - write `mosaic_cleaned_enhanced.fits`,  
        - produce before/after detection overlays.  
      - The cleaned mosaic is the one used for the final number–count analysis.

   4. **Test aperture photometry**  
      - Open `aperture photometry.ipynb`.  
      - Run to check that:  
        - the 3″ aperture and sky annulus are correctly converted to pixels,  
        - the local sky estimates look sensible,  
        - the net fluxes for bright isolated objects behave as expected.

   5. **Build the source catalogue and classify objects**  
      - Open `analysis.ipynb`.  
      - Choose the input image (`mosaic_cleaned_enhanced.fits` for the final  
        results).  
      - Run to:  
        - detect sources at `bg + 5σ`,  
        - apply minimum-area and edge cuts,  
        - apply the halo mask from the kNN step,  
        - perform aperture photometry for all remaining detections,  
        - classify objects as stars or galaxies using concentration and size.

   6. **Compute number counts and fit the log N – m relation**  
      - Open `results.ipynb`.  
      - Run to:  
        - construct cumulative counts `N(<m)` and `log₁₀ N(<m)` in magnitude bins  
          (e.g. Δm = 0.25),  
        - make curves for all sources, stars only, and galaxies only,  
        - add Poisson error bars,  
        - perform weighted straight-line fits to the **galaxy** `log N – m`  
          relation over the chosen magnitude range,  
        - optionally test how the fitted slope changes with:  
          - fitting range,  
          - kNN crowded-fraction and grid size,  
        - save the final plots (PNG/JPG) for inclusion in the written report.

